/// # Authentication Service Schema
///
/// This Prisma schema defines the data models for an authentication service with support for:
/// - User account management with role-based access control
/// - Email verification and password reset via OTP
/// - JWT refresh token management
/// - Wallet address linking and verification
///
/// ## Enums
/// - **UserRole**: Defines user permission levels (USER, ADMIN, ARBITRATOR)
/// - **UserStatus**: Tracks user account state (ACTIVE, SUSPENDED, DELETED)
/// - **OTPPurpose**: Specifies OTP usage context (EMAIL_VERIFICATION, PASSWORD_RESET, TWO_FACTOR_AUTH)
///
/// ## Models
/// - **User**: Core user account with email authentication and status tracking
/// - **RefreshToken**: Secure JWT refresh token storage with revocation support
/// - **OTP**: One-time password management with expiry and attempt tracking
/// - **WalletLink**: Blockchain wallet address linking with signature verification
/// - **ResetPasswordToken**: Password reset token with expiry and single-use enforcement
///
/// All token models cascade delete on user removal and include indexed foreign keys for query performance.

generator client {
  // Required
  provider = "prisma-client"
  output = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

/// ========================
/// ENUM DEFINITIONS
/// ========================

enum UserRole {
  USER
  ADMIN
  ARBITRATOR
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

enum OTPPurpose {
  EMAIL_VERIFICATION
  PASSWORD_RESET
  TWO_FACTOR_AUTH
}

/// ========================
/// MODEL DEFINITIONS
/// ========================

model User {
  id            String               @id @default(cuid())
  email         String               @unique
  passwordHash  String
  createdAt     DateTime             @default(now())
  isVerified    Boolean              @default(false)
  updatedAt     DateTime             @updatedAt
  status        UserStatus           @default(ACTIVE) // ACTIVE, SUSPENDED, DELETED
  role          UserRole             @default(USER) // USER, ADMIN, ARBITRATOR
  lastLoginAt   DateTime?
  otps          OTP[]
  refreshTokens RefreshToken[]
  resetTokens   ResetPasswordToken[]
  walletLinks   WalletLink[]
}

model RefreshToken {
  id        String   @id @default(cuid())
  tokenHash String   @unique
  userId    String
  expiryAt  DateTime
  revoked   Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model OTP {
  id            String   @id @default(cuid())
  codeHash      String
  purpose       OTPPurpose
  userId        String
  used          Boolean  @default(false)
  attemptCount  Int      @default(0)
  createdAt     DateTime @default(now())
  expiryAt      DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model WalletLink {
  id            String   @id @default(cuid())
  walletAddress String   @unique
  chain         String
  userId        String
  verified      Boolean  @default(false)
  signature     String   // message signature
  createdAt     DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ResetPasswordToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  expiryAt  DateTime
  userReset User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
